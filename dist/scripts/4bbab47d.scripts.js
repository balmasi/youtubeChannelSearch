"use strict";var app=angular.module("youtubeApiApp",["ngResource","ngRoute","firebase","youtubeApiApp.services.channels","scroll"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).constant("FBURL","https://yousearch.firebaseio.com/");app.run(["FBURL","$rootScope",function(a,b){b.FBURL=a}]),angular.module("youtubeApiApp.services.fireRef",[]).factory("FireRef",["FBURL","Firebase",function(a,b){return{channels:function(){return new b(a+"/channels")},deadChannels:function(){return new b(a+"/deadChannels")}}}]),angular.module("youtubeApiApp.services.channels",["youtubeApiApp.services.fireRef"]).factory("channelService",["FireRef","$firebase",function(a,b){return{getRef:function(){return a.channels()},deadCollection:function(){return b(a.deadChannels())},deadFind:function(b){return a.deadChannels().child("/"+b)},collection:function(){return b(a.channels())},find:function(b){return a.channels().child("/"+b)},create:function(b){return a.channels().push(b)},removeChannel:function(b){var c=a.channels().child("/"+b);c.remove()}}}]),angular.module("youtubeApiApp").service("googleService",["$http","$rootScope","$q",function(a,b,c){var d="888692197820.apps.googleusercontent.com",e="AIzaSyAynQVlpxxYZr7TJWytodnDhruwKwpveII",f="{SCOPES}",g="localhost",h=c.defer();this.login=function(){return gapi.auth.authorize({client_id:d,scope:f,immediate:!1,hd:g},this.handleAuthResult),h.promise},this.handleClientLoad=function(){var a=c.defer();return gapi.client.setApiKey(e),gapi.client.load("youtube","v3",function(b){angular.isUndefined(b)&&a.resolve("Locked and Loaded"),a.reject(b)}),a.promise},this.checkAuth=function(){gapi.auth.authorize({client_id:d,scope:f,immediate:!0,hd:g},this.handleAuthResult)},this.handleAuthResult=function(a){if(a&&!a.error){var b={};gapi.client.load("oauth2","v2",function(){var a=gapi.client.oauth2.userinfo.get();a.execute(function(a){b.email=a.email})}),h.resolve(b)}else h.reject("error")},this.handleAuthClick=function(){return gapi.auth.authorize({client_id:d,scope:f,immediate:!1,hd:g},this.handleAuthResult),!1}}]).controller("MainCtrl",["$scope","googleService","$window","channelService","$q",function(a,b,c,d,e){function f(a){return a.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]{3,}\.[a-zA-Z0-9._-]{2,3})/gi)}function g(b){var c=e.defer();return gapi.client.youtube.search.list(b).execute(function(b){var d=null;return angular.isDefined(b.error)?void c.reject(b.error):(a.$apply(function(){k.next=b.nextPageToken,k.prev=b.prevPageToken,k.numResults=b.pageInfo.totalResults,b.items.forEach(function(b){var c=b.id.channelId;i[c]?a.resultChannels[c]=i[c]:j[c]||(d={shortDescription:b.snippet.description.slice(0,100)+"...",description:b.snippet.description,channelTitle:b.snippet.channelTitle,title:b.snippet.title,image:b.snippet.thumbnails.default.url},h(d,c))})}),void c.resolve(b.nextPageToken||null))}),c.promise}function h(b,c){gapi.client.youtube.channels.list({id:c,part:"contentDetails,statistics, status,snippet",fields:"items(contentDetails,statistics,status,snippet)"}).execute(function(d){a.$apply(function(){var e=d.items[0];angular.isUndefined(e.contentDetails.googlePlusUserId)||(b.gPlus=e.contentDetails.googlePlusUserId),b.numSubscribers=e.statistics.subscriberCount,b.numViews=e.statistics.viewCount,b.description=e.snippet.description;var g=f(b.description);g&&g.length?(b.email=g,i[c]=b,a.resultChannels[c]=i[c],i.$save(c)):(j[c]={subscribers:b.numSubscribers},j.$save(c))})})}var i=d.collection(),j=d.deadCollection(),k={next:null,prev:null,timesQueried:0,numResults:0,reset:function(){this.next=null,this.prev=null,this.timesQueried=0,this.numResults=0}},l={minResultsPerQuery:10,maxTriesPerLoad:10,resultsPerRequest:10};a.loading=!0,a.notEnoughResults=!1,a.uiOptions={order:["relevance","date","rating","title","videoCount","viewCount"]},a.searchOptions={query:null,order:a.uiOptions.order[0],fields:"items(id,snippet),nextPageToken,prevPageToken,tokenPagination,pageInfo"},a.resultChannels={},a.hasResults=function(){return!angular.equals(a.resultChannels,{})},a.clear=function(){a.resultChannels={},a.notEnoughResults=!1,k.reset()},a.scrolled=function(){a.search()},a.search=function(){var b={q:a.searchOptions.query,part:"snippet",order:a.searchOptions.order,type:"channel",fields:a.searchOptions.fields,maxResults:l.resultsPerRequest};null!==k.next&&(b.pageToken=k.next),k.timesQueried+=1,a.loading=!0,g(b).then(function(b){if(k.numResults<500&&(1==k.timesQueried||k.timesQueried>=5))alert("Not Enough Results. Try a better query."),a.notEnoughResults=!0;else if(null!==b&&k.timesQueried<l.maxTriesPerLoad){var c=Object.keys(a.resultChannels).length;c<l.minResultsPerQuery&&(k.next=b,a.search())}a.loading=!1},function(b){a.loading=!1,console.error(b)})},c.handleClientLoad=function(){b.handleClientLoad().then(function(){a.loading=!1})};var m=document.createElement("script");m.type="text/javascript",m.src="https://apis.google.com/js/client.js?onload=handleClientLoad",document.body.appendChild(m)}]),angular.module("scroll",[]).directive("scrollever",function(){return{restrict:"A",link:function(a,b,c){$(document).on("scroll",function(){var b=document.body;b.scrollTop+$(window).height()>=b.scrollHeight&&a.$apply(c.scrollever)})}}});